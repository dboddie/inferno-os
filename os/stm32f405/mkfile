<../../mkconfig

#CONF=micromod-stm32f405
#CONFLIST=micromod-stm32f405
CONF=stm32f405.conf
CONFLIST=stm32f405.conf
loadaddr=0x08000000
# Put data at the start of RAM.
dataaddr=0x20000000

SYSTARG=$OSTARG
OBJTYPE=thumb
INSTALLDIR=$ROOT/Inferno/$OBJTYPE/bin

<$ROOT/mkfiles/mkfile-$SYSTARG-$OBJTYPE

<| $SHELLNAME ../port/mkdevlist $CONF

MODFILES=`ls frozen/*mod.s`
STRUCTS=${MODFILES:frozen/%.s=extern FrozenMod\ %;\\n}
CALLS=${MODFILES:frozen/%.s=addfrozenmod(\&%);'\\'\\n}

OBJ=\
	l.$O\
	main.$O\
	clock.$O\
	dump.$O\
	thumb2.$O\
	trap.$O\
	devices/clocks.$O\
	devices/gpio.$O\
	devices/sys.$O\
#	$IP\
	$DEVS\
#	$ETHERS\
	$LINKS\
	$PORT\
	$MISC\
	$OTHERS\
	$CONF.root.$O\
	frozen.$O\
	${MODFILES:%.s=%.$O}

LIBNAMES=${LIBS:%=lib%.a}
LIBDIRS=$LIBS

# Strip off the devices prefix of any object paths.
NOPREFIXOBJ=${OBJ:devices/%=%}
NOPREFIXOBJ=${NOPREFIXOBJ:frozen/%=%}

HFILES=\
	mem.h\
	dat.h\
	fns.h\
	io.h\
	fpi.h\
	frozen.h\

CFLAGS=-wFV -I./include -I./peripherals -I$ROOT/include -I$ROOT/libinterp
LDFLAGS=-H0 -l -s -a
KERNDATE=`{$NDATE}

default:V: kernel

kernel: $OBJ $CONF.c $CONF.root.h $LIBNAMES frozen.h
	echo $ROOT/mkfiles/mkfile-$SYSTARG-$OBJTYPE
	$CC $CFLAGS -DKERNDATE=$KERNDATE $CONF.c
	$LD $LDFLAGS -o $target -R0 -T$loadaddr -D$dataaddr $NOPREFIXOBJ $CONF.$O $LIBFILES

<../port/portmkfile

main.$O:	include/ureg.h

frozen.h:V:
	echo $STRUCTS > frozen.h
	echo '#define InitFrozen \\' >> frozen.h
	echo $CALLS >> frozen.h
