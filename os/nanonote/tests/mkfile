<../../../mkconfig

# must match mem.h
BY2PG=4096

# Redefine target and architecture.
SYSTARG=$OSTARG
OBJTYPE=spim
INSTALLDIR=$ROOT/Inferno/$OBJTYPE/bin

loadaddr=0x81c00000
execaddr=0x81c0004c

# Re-read the target configuration file.
<$ROOT/mkfiles/mkfile-$SYSTARG-$OBJTYPE

OBJ=\
	start0.$O\
	start1.$O\
	start2.$O\
	start3.$O

# Since each object file is assembled to produce its own binary, strip the
# suffix from each of them to find the binaries to delete when cleaning up.
CLEANEXTRA=${OBJ:%.$O=%} uImage-* *.bin main4 main5 ctest0

default:V: $OBJ

# Link the code at the execution address and load the whole binary using U-Boot
# then execute the code starting from the beginning of the program.
main4:  start4.s main4.c
	$AS $ASFLAGS start4.s
	$CC $CFLAGS main4.c
	$LD $LDFLAGS -a -H0 -l -R$BY2PG -T$execaddr -s -o main4 start4.$O main4.$O
	mkimage -A mips -O linux -T kernel -C none -a $loadaddr -e $execaddr -n main4 -d main4 uImage-main4

ctest0: commonstart.s ctest0.c fbdraw.c
	$AS $ASFLAGS commonstart.s
	$CC $CFLAGS ctest0.c fbdraw.c
	$LD $LDFLAGS -a -H0 -l -R$BY2PG -T$execaddr -s -o ctest0 commonstart.$O ctest0.$O
	mkimage -A mips -O linux -T kernel -C none -a $loadaddr -e $execaddr -n ctest0 -d ctest0 uImage-ctest0

%.$O:	%.s
	$AS $ASFLAGS $stem.s
	$LD $LDFLAGS -a -H0 -l -R$BY2PG -T$loadaddr -s -o $stem $stem.$O
	dd if=$stem of=$stem.bin bs=1 skip=76
	mkimage -A mips -O linux -T kernel -C none -a $loadaddr -e $loadaddr -n $stem -d $stem.bin uImage-$stem

%.$O:	%.c
	$CC $CFLAGS $stem.c

clean:V:	cleanconf-$SHELLTYPE
		rm -f *.[$OS] *.root.[sh] errstr.h *.out $CLEANEXTRA

cleanconf-sh:V:
		for i in $CONFLIST $CLEANCONFLIST
		do
			rm -f $i.c i$i i$i.* $i.ver
		done
